---
title: "AH_AICc_bodysize~SP"
author: "Abby Host"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE)
```

#' =====================================================
#' AICc code for BodySizePC_1~SpawningPopulation models
#' =====================================================

### Loading Data
```{r}
rm(list = ls())
library(AICcmodavg)
library(lubridate)
library(ggplot2)

#data loading
# bc19 <- read.csv("bodycomp_2019.csv")
# bc20 <- read.csv("bodycomp_2020.csv")
#bc21 <- read.csv("bodycomp_2021.csv")
#need to bind all together for total body comp dataset, Upper River river only

# bc_UR_total <- rbind(bc19[61:172,], bc20[61:120,], bc21[61:182,])
# write.csv(bc_UR_total, "upperriver_bodycomp_all.csv")
upperriver_bodycomp_all<-read.csv("upperriver_bodycomp_all.csv")[,-1]
#all data is loaded now

#need to add year to dataset
str(upperriver_bodycomp_all)
upperriver_bodycomp_all$Collection_Date <- as.Date(upperriver_bodycomp_all$Collection_Date)

# Create a new column 'year' from the collection_date
upperriver_bodycomp_all$Year <- year(upperriver_bodycomp_all$Collection_Date)
str(upperriver_bodycomp_all)

#replace blank cell in Sex with NA 
upperriver_bodycomp_all$Sex[upperriver_bodycomp_all$Sex == ""] <- NA
str(upperriver_bodycomp_all)

write.csv(upperriver_bodycomp_all, "upperriver_bodycomp_all.csv")
```

### Checking for NAs for PC score 
```{r}
rm(list = ls())
upperriver_bodycomp_all <- "upperriver_bodycomp_all.csv"
upperriver_bodycomp_all<-read.csv("upperriver_bodycomp_all.csv")[,-1]

##### For the Upper River Data, I want to eliminate Power Creek Cordova, Eyak Weir Cordova, Bone Creek, and Copper Lake data points as they don't apply to my spawning populations of interest ####
library(dplyr)

# Assuming your data frame is named df, use filter() to exclude the specific collection locations
upperriver_bodycomp_all <- upperriver_bodycomp_all %>%
  filter(!Collection_Location %in% c("Power Creek Cordova", "Eyak Weir Cordova", "Bone Creek", "Copper Lake", "Klutina River", "Upper Klutina"))


### Now, need to remove NAs that will mess up levels / model weight
any(is.na(upperriver_bodycomp_all$Collection_Location))
any(is.na(upperriver_bodycomp_all$Collection_RiverMile_m))
any(is.na(upperriver_bodycomp_all$Elevation_m))
any(is.na(upperriver_bodycomp_all$Year))
any(is.na(upperriver_bodycomp_all$Sex))
upperriver_bodycomp_all[is.na(upperriver_bodycomp_all$Sex), ] #row 87 and 110 has no sex value, eliminate it for models
upperriver_bodycomp_all <- upperriver_bodycomp_all[-c(87,110),] #excludes row missing sex file
any(is.na(upperriver_bodycomp_all$Sex))

#checking NA
any(is.na(upperriver_bodycomp_all$Fish_Leng_1))
upperriver_bodycomp_all[is.na(upperriver_bodycomp_all$Fish_Leng_1), ]
any(is.na(upperriver_bodycomp_all$Fish_Leng_2))
upperriver_bodycomp_all[is.na(upperriver_bodycomp_all$Fish_Leng_2), ]
any(is.na(upperriver_bodycomp_all$Fish_Ht))
upperriver_bodycomp_all[is.na(upperriver_bodycomp_all$Fish_Ht), ]
any(is.na(upperriver_bodycomp_all$Fish_Grth)) 
upperriver_bodycomp_all[is.na(upperriver_bodycomp_all$Fish_Grth), ] 
any(is.na(upperriver_bodycomp_all$Fish_Wdth)) 
upperriver_bodycomp_all[is.na(upperriver_bodycomp_all$Fish_Wdth), ] 
## NAs present in each of these variables, will need to estimate for values before PC score can be run to quantify body size of these samples
```

### Convert body size metrics to grams and mm
```{r}
upperriver_bodycomp_all$Fish_Leng_1_mm <- upperriver_bodycomp_all$Fish_Leng_1*10
upperriver_bodycomp_all$Fish_Leng_2_mm <- upperriver_bodycomp_all$Fish_Leng_2*10
upperriver_bodycomp_all$Fish_Ht_mm <- upperriver_bodycomp_all$Fish_Ht*10
upperriver_bodycomp_all$Fish_Grth_mm <- upperriver_bodycomp_all$Fish_Grth*10
upperriver_bodycomp_all$Fish_Wt_g <- upperriver_bodycomp_all$Fish_Wt*1000


```

### Estimate length_1 Values for NA rows
```{r}
#Determine best metric for estimating NAs for Leng_1
summary(lm(Fish_Leng_1_mm ~ Fish_Leng_2_mm, data = upperriver_bodycomp_all)) #R = 0.06
summary(lm(Fish_Leng_1_mm ~ Fish_Ht_mm, data = upperriver_bodycomp_all)) #R = 0.316
summary(lm(Fish_Leng_1_mm ~ Fish_Wt_g, data = upperriver_bodycomp_all)) #R = 0.6635
summary(lm(Fish_Leng_1_mm ~ Fish_Grth_mm, data = upperriver_bodycomp_all)) # Adjusted R-squared:  0.4036


# Subset the data for female F fish only
allF_upperriver_bodycomp_all <- upperriver_bodycomp_all[upperriver_bodycomp_all$Sex == "F", ]

leng1_F_lm <- lm(Fish_Leng_1_mm ~ Fish_Wt_g, data = allF_upperriver_bodycomp_all)
summary(leng1_F_lm) # R squared  0.6396
plot(leng1_F_lm)


predicted_values_lengF_mm <- predict(leng1_F_lm, newdata = allF_upperriver_bodycomp_all)

allF_upperriver_bodycomp_all$Predicted_Fish_Leng_1_mm <- predicted_values_lengF_mm # Add these predictions back to your dataset


ggplot(allF_upperriver_bodycomp_all, aes(x = Predicted_Fish_Leng_1_mm, y = Fish_Leng_1_mm)) +
  geom_point(aes(color = "Observed")) +
  geom_point(aes(y = Predicted_Fish_Leng_1_mm, color = "Predicted")) +
  scale_color_manual(values = c("Observed" = "blue", "Predicted" = "red")) +
  labs(title = "Observed vs Predicted Female Fish",
       x = "Predicted Fish Length",
       y = "Fish Length") +
  theme_minimal() 

# Replace NAs in Fish_Leng_1 with predicted values
allF_upperriver_bodycomp_all$Fish_Leng_1_mm[is.na(allF_upperriver_bodycomp_all$Fish_Leng_1_mm)] <- allF_upperriver_bodycomp_all$Predicted_Fish_Leng_1_mm[is.na(allF_upperriver_bodycomp_all$Fish_Leng_1_mm)]
## so now, the female subset has predicted values replacing the NAs for Leng_1


#Now, same for the male data
allM_upperriver_bodycomp_all <- upperriver_bodycomp_all[upperriver_bodycomp_all$Sex == "M", ] #subset of M from total data set

leng1_M_lm <- lm(Fish_Leng_1_mm ~ Fish_Wt_g, data = allM_upperriver_bodycomp_all) #making linear regression
summary(leng1_M_lm) # R squared is 0.6251
plot(leng1_M_lm)
predicted_values_lengM_mm <- predict(leng1_M_lm, newdata = allM_upperriver_bodycomp_all) #predicting width values from male subset data
allM_upperriver_bodycomp_all$Predicted_Fish_Leng_1_mm <- predicted_values_lengM_mm

ggplot(allM_upperriver_bodycomp_all, aes(x = Predicted_Fish_Leng_1_mm, y = Fish_Leng_1_mm)) +
  geom_point(aes(color = "Observed")) +
  geom_point(aes(y = Predicted_Fish_Leng_1_mm, color = "Predicted")) +
  scale_color_manual(values = c("Observed" = "blue", "Predicted" = "red")) +
  labs(title = "Observed vs Predicted Male Fish Length 1",
       x = "Comparison PC",
       y = "Fish Growth") +
  theme_minimal() 

# Replace NAs in Fish_Leng_1 with predicted values
allM_upperriver_bodycomp_all$Fish_Leng_1_mm[is.na(allM_upperriver_bodycomp_all$Fish_Leng_1_mm)] <- allM_upperriver_bodycomp_all$Predicted_Fish_Leng_1_mm[is.na(allM_upperriver_bodycomp_all$Fish_Leng_1_mm)]
## so now, the male subset has predicted values replacing the NAs 

### Now, combine the two data sets back into one, called lowerriver_bodycomp_all ###
upperriver_bodycomp_all <- rbind(allF_upperriver_bodycomp_all, allM_upperriver_bodycomp_all)

#Check Leng_1 NAs
any(is.na(upperriver_bodycomp_all$Fish_Leng_1_mm)) #FALSE
```


### Estimate Girth Values for NA rows
```{r}
#Determine best metric for estimating NAs for Girth
summary(lm(Fish_Grth_mm ~ Fish_Leng_1_mm, data = upperriver_bodycomp_all)) # R = 0.396
summary(lm(Fish_Grth_mm ~ Fish_Ht_mm, data = upperriver_bodycomp_all)) #R = 0.8013
summary(lm(Fish_Grth_mm ~ Fish_Wt_g, data = upperriver_bodycomp_all)) #R = 0.796 
summary(lm(Fish_Grth_mm ~ Fish_Leng_2_mm, data = upperriver_bodycomp_all)) # Adjusted R-squared = 0.097

# Subset the data for female F fish only
allF_upperriver_bodycomp_all <- upperriver_bodycomp_all[upperriver_bodycomp_all$Sex == "F", ]

summary(lm(Fish_Grth_mm ~ Fish_Ht_mm, data = allF_upperriver_bodycomp_all)) #R = 0.639
summary(lm(Fish_Grth_mm ~ Fish_Wt_g, data = allF_upperriver_bodycomp_all)) #R =  0.699

grth_F_lm <- lm(Fish_Grth_mm ~ Fish_Wt_g, data = allF_upperriver_bodycomp_all)
summary(grth_F_lm) # R squared  0.7 
plot(grth_F_lm)


predicted_values_grthF <- predict(grth_F_lm, newdata = allF_upperriver_bodycomp_all)

allF_upperriver_bodycomp_all$Predicted_Fish_Grth_mm <- predicted_values_grthF # Add these predictions back to your dataset


ggplot(allF_upperriver_bodycomp_all, aes(x = Predicted_Fish_Grth_mm, y = Fish_Grth_mm)) +
  geom_point(aes(color = "Observed")) +
  geom_point(aes(y = Predicted_Fish_Grth_mm, color = "Predicted")) +
  scale_color_manual(values = c("Observed" = "blue", "Predicted" = "red")) +
  labs(title = "Observed vs Predicted Female Fish",
       x = "Predicted Fish Girth",
       y = "Fish Girth") +
  theme_minimal() 

# Replace NAs in Fish_Grth with predicted values
allF_upperriver_bodycomp_all$Fish_Grth_mm[is.na(allF_upperriver_bodycomp_all$Fish_Grth_mm)] <- allF_upperriver_bodycomp_all$Predicted_Fish_Grth_mm[is.na(allF_upperriver_bodycomp_all$Fish_Grth_mm)]
## so now, the female subset has predicted values replacing the NAs for Grth


#Now, same for the male data
allM_upperriver_bodycomp_all <- upperriver_bodycomp_all[upperriver_bodycomp_all$Sex == "M", ] #subset of M from total data set

grth_M_lm <- lm(Fish_Grth_mm ~ Fish_Wt_g, data = allM_upperriver_bodycomp_all) #making linear regression
summary(grth_M_lm) # R squared is 0.68
plot(grth_M_lm)
predicted_values_grthM <- predict(grth_M_lm, newdata = allM_upperriver_bodycomp_all) #predicting width values from male subset data
allM_upperriver_bodycomp_all$Predicted_Fish_Grth_mm <- predicted_values_grthM

ggplot(allM_upperriver_bodycomp_all, aes(x = Predicted_Fish_Grth_mm, y = Fish_Grth_mm)) +
  geom_point(aes(color = "Observed")) +
  geom_point(aes(y = Predicted_Fish_Grth_mm, color = "Predicted")) +
  scale_color_manual(values = c("Observed" = "blue", "Predicted" = "red")) +
  labs(title = "Observed vs Predicted Male Fish Girth",
       x = "Predicted Fish Girth",
       y = "Fish Girth") +
  theme_minimal() 

# Replace NAs in Fish_Wdth with predicted values
allM_upperriver_bodycomp_all$Fish_Grth_mm[is.na(allM_upperriver_bodycomp_all$Fish_Grth_mm)] <- allM_upperriver_bodycomp_all$Predicted_Fish_Grth_mm[is.na(allM_upperriver_bodycomp_all$Fish_Grth_mm)]
## so now, the male subset has predicted values replacing the NAs 

### Now, combine the two data sets back into one, called lowerriver_bodycomp_all ###
upperriver_bodycomp_all <- rbind(allF_upperriver_bodycomp_all, allM_upperriver_bodycomp_all)

#Check Leng_1 NAs
any(is.na(upperriver_bodycomp_all$Fish_Leng_1_mm)) #FALSE
any(is.na(upperriver_bodycomp_all$Fish_Grth_mm)) #FALSE

```

### Estimate Height Values for NA rows
```{r}
#Determine best metric for estimating NAs for Height
summary(lm(Fish_Ht_mm ~ Fish_Leng_1_mm, data = upperriver_bodycomp_all)) # R = 0.316 
summary(lm(Fish_Ht_mm ~ Fish_Grth_mm, data = upperriver_bodycomp_all)) #R = 0.7962 
summary(lm(Fish_Ht_mm ~ Fish_Wt_g, data = upperriver_bodycomp_all)) #R = 0.643
summary(lm(Fish_Ht_mm ~ Fish_Leng_2_mm, data = upperriver_bodycomp_all)) # Adjusted R-squared = 0.11

# Subset the data for female F fish only
allF_upperriver_bodycomp_all <- upperriver_bodycomp_all[upperriver_bodycomp_all$Sex == "F", ]

summary(lm(Fish_Ht_mm ~ Fish_Grth_mm, data = allF_upperriver_bodycomp_all)) #R = 0.6364 


Ht_F_lm <- lm(Fish_Ht_mm ~ Fish_Grth_mm, data = allF_upperriver_bodycomp_all)
summary(Ht_F_lm) # R squared  0.64
plot(Ht_F_lm)


predicted_values_HtF <- predict(Ht_F_lm, newdata = allF_upperriver_bodycomp_all)

allF_upperriver_bodycomp_all$Predicted_Fish_Ht_mm <- predicted_values_HtF # Add these predictions back to your dataset


ggplot(allF_upperriver_bodycomp_all, aes(x = Predicted_Fish_Ht_mm, y = Fish_Ht_mm)) +
  geom_point(aes(color = "Observed")) +
  geom_point(aes(y = Predicted_Fish_Ht_mm, color = "Predicted")) +
  scale_color_manual(values = c("Observed" = "blue", "Predicted" = "red")) +
  labs(title = "Observed vs Predicted Female Fish Height",
       x = "Predicted Fish Height",
       y = "Fish Height") +
  theme_minimal() 

# Replace NAs in Fish_Grth with predicted values
allF_upperriver_bodycomp_all$Fish_Ht_mm[is.na(allF_upperriver_bodycomp_all$Fish_Ht_mm)] <- allF_upperriver_bodycomp_all$Predicted_Fish_Ht_mm[is.na(allF_upperriver_bodycomp_all$Fish_Ht_mm)]
## so now, the female subset has predicted values replacing the NAs for Grth


#Now, same for the male data
allM_upperriver_bodycomp_all <- upperriver_bodycomp_all[upperriver_bodycomp_all$Sex == "M", ] #subset of M from total data set

Ht_M_lm <- lm(Fish_Ht_mm ~ Fish_Grth_mm, data = allM_upperriver_bodycomp_all) #making linear regression
summary(Ht_M_lm) # R squared is 0.71
plot(Ht_M_lm)
predicted_values_HtM <- predict(Ht_M_lm, newdata = allM_upperriver_bodycomp_all) #predicting width values from male subset data
allM_upperriver_bodycomp_all$Predicted_Fish_Ht_mm <- predicted_values_HtM

ggplot(allM_upperriver_bodycomp_all, aes(x = Predicted_Fish_Ht_mm, y = Fish_Ht_mm)) +
  geom_point(aes(color = "Observed")) +
  geom_point(aes(y = Predicted_Fish_Ht_mm, color = "Predicted")) +
  scale_color_manual(values = c("Observed" = "blue", "Predicted" = "red")) +
  labs(title = "Observed vs Predicted Male Fish Height",
       x = "Predicted Fish Height",
       y = "Fish Height") +
  theme_minimal() 

# Replace NAs in Fish_Wdth with predicted values
allM_upperriver_bodycomp_all$Fish_Ht_mm[is.na(allM_upperriver_bodycomp_all$Fish_Ht_mm)] <- allM_upperriver_bodycomp_all$Predicted_Fish_Ht_mm[is.na(allM_upperriver_bodycomp_all$Fish_Ht_mm)]
## so now, the male subset has predicted values replacing the NAs 

### Now, combine the two data sets back into one, called lowerriver_bodycomp_all ###
upperriver_bodycomp_all <- rbind(allF_upperriver_bodycomp_all, allM_upperriver_bodycomp_all)

#Check Leng_1 NAs
any(is.na(upperriver_bodycomp_all$Fish_Leng_1_mm)) #FALSE
any(is.na(upperriver_bodycomp_all$Fish_Grth_mm)) #FALSE
any(is.na(upperriver_bodycomp_all$Fish_Ht_mm)) #FALSE

```

### Making body size metric via PC score of Leng_1, Fish_Ht, and Fish_Grth
```{r}
str(upperriver_bodycomp_all)

## PC scores via linear regression for body size analysis ### 
bc_pca1 <- princomp(upperriver_bodycomp_all[,c(83,85,86)], cor=T, scores=T, covmat = NULL) #should work now without any NAs
summary(lm(upperriver_bodycomp_all$Fish_Leng_1_mm ~ bc_pca1$scores[,1])) #R = 0.641

summary(bc_pca1, loadings=T, cutoff=0.0001) #summary of PC analysis
bc_pca1$scores
screeplot(bc_pca1, type=c('lines'))
bodysize_pc_g_mm <- bc_pca1$scores[,1]

#combine dataframe with column for body size PC scores
upperriver_bodycomp_pc <- cbind(upperriver_bodycomp_all, bodysize_pc_g_mm) 
str(upperriver_bodycomp_pc)
upperriver_bodycomp_pc <- upperriver_bodycomp_pc[,-(88:90)]
str(upperriver_bodycomp_pc)

#Now, run AIC again but PC1 scores are the response variable / numeric
write.csv(upperriver_bodycomp_pc, "upperriver_bodycomp_PCscores.csv")
```

### Import Data for models
```{r}
rm(list = ls())
upperriver_bodycomp_PCscores <- "upperriver_bodycomp_PCscores.csv"

# Import the data. Be sure to check the structure of the data and that R is reading continuous and categorical variables appropriately.
DataSet<-read.csv(upperriver_bodycomp_PCscores)[,-1] #88 variables, 237 observations b/c one row with NA sex is removed
any(is.na(DataSet$Fish_Leng_1_mm)) #FALSE
any(is.na(DataSet$Fish_Grth_mm)) #FALSE
any(is.na(DataSet$Fish_Ht_mm)) #FALSE

any(is.na(DataSet$Collection_Location)) #FALSE
any(is.na(DataSet$Year)) #FALSE
any(is.na(DataSet$Sex)) #FALSE
any(is.na(DataSet$Collection_RiverMile_m)) # FALSE
any(is.na(DataSet$Elevation_m)) #FALSE

#### CHECK DIRECTION OF PC SCORE ###
library(ggplot2)
ggplot(DataSet, aes(x=Fish_Leng_1_mm, y=bodysize_pc_g_mm)) +
  geom_point()
#so direction of PC score is positive, can check with other variables


# View DataSet.
head(DataSet)
summary(DataSet)
nrow(DataSet)
str(DataSet)
levels(DataSet$Collection_Location)

#Make work metric (migratory difficulty metric where work = F x distance)
DataSet$Elevation_m <- as.numeric(DataSet$Elevation_m)
DataSet$Work <- round((DataSet$Collection_RiverMile_m * DataSet$Elevation_m) / (1000 * 1000), digits = 1) #in km^2
str(DataSet) 

#convert gonad_wt to grams from kilograms
DataSet$Gonad_Wt_g <- DataSet$Gonad_Wt * 1000

#make response variables factors
DataSet$Collection_Location <- as.factor(DataSet$Collection_Location)
levels(DataSet$Collection_Location) # 7 unique locations
DataSet$Year<- as.factor(DataSet$Year)
levels(DataSet$Year)
DataSet$Sex<- as.factor(DataSet$Sex)
str(DataSet)


#check gonad weight for NAs
any(is.na(DataSet$Gonad_Wt_g))
DataSet[is.na(DataSet$Gonad_Wt_g), ] #need to eliminate these rows or model selection will not work
DataSet <- DataSet[-c(8, 19, 20, 31, 35, 37, 50, 59, 70, 71, 73, 81, 84, 111, 112, 114),]
any(is.na(DataSet$Gonad_Wt_g)) #FALSE


#check normality
hist(DataSet$bodysize_pc_g_mm) #normal!
qqnorm(DataSet$bodysize_pc_g_mm)
qqline(DataSet$bodysize_pc_g_mm, col = "red")
shapiro.test(DataSet$bodysize_pc_g_mm)
boxplot(DataSet$bodysize_pc_g_mm, main = "Boxplot of Body Size", col = "lightgreen")

```

### Making Models for bodysize_pc~SpawningPopulation, includes SpawnStatus
```{r}
# Models for reference
bodysize_SP_modelset <- "bodysize_spawningpopulation/bodysize~SpawningPopulation_modelset.csv" #this needs to be edited

ModelSet<-read.csv(bodysize_SP_modelset) 

#DataSet$Work <- factor(DataSet$Work) #This is an important fix, otherwise its numeric but in fact its discrete factors

model1 <- lm(bodysize_pc_g_mm~1, data=DataSet)
model2 <- lm(bodysize_pc_g_mm~ Gonad_Wt_g + Collection_Location, data = DataSet)
model3 <- lm(bodysize_pc_g_mm~ Gonad_Wt_g + Sex, data = DataSet)
model4 <- lm(bodysize_pc_g_mm~ Gonad_Wt_g + Year, data = DataSet)
model5 <- lm(bodysize_pc_g_mm~ Gonad_Wt_g + Collection_Location + Sex, data = DataSet)
model6 <- lm(bodysize_pc_g_mm~ Gonad_Wt_g + Collection_Location + Year, data = DataSet)
model7 <- lm(bodysize_pc_g_mm~ Gonad_Wt_g + Sex + Year, data = DataSet)
model8 <- lm(bodysize_pc_g_mm~ Gonad_Wt_g + Collection_Location + Sex + Collection_Location:Sex, data = DataSet)
model9 <- lm(bodysize_pc_g_mm~Gonad_Wt_g + Sex + Year + Sex:Year, data = DataSet)
model10 <- lm(bodysize_pc_g_mm~ Gonad_Wt_g + Collection_Location + Sex + Year, data = DataSet)
```

### AICc Model Selection
```{r}
AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10)

#table of AIC results
mynames1 <- paste("model", as.character(1:10), sep = "")
models <- list(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10)

# Generate AIC table
myaicc1 <- aictab(models, modnames = mynames1)
print(myaicc1)
# Convert AIC table to a data frame for easier manipulation
aic_df <- as.data.frame(myaicc1)
aic_df$ModelName <- c("bodysize_pc_g_mm~ Gonad_Wt_g + Collection_Location + Sex + Year",
                      "bodysize_pc_g_mm~ Gonad_Wt_g + Sex + Year",
                      "bodysize_pc_g_mm~Gonad_Wt_g + Sex + Year + Sex:Year",
                      "bodysize_pc_g_mm~ Gonad_Wt_g + Collection_Location + Sex",
                      "bodysize_pc_g_mm~ Gonad_Wt_g + Sex",
                      "bodysize_pc_g_mm~ Gonad_Wt_g + Collection_Location + Sex + Collection_Location:Sex",
                      "bodysize_pc_g_mm~ Gonad_Wt_g + Year",
                      "bodysize_pc_g_mm~ Gonad_Wt_g + Collection_Location + Year",
                      "bodysize_pc_g_mm~1",
                      "bodysize_pc_g_mm~ Gonad_Wt_g + Collection_Location")
colnames(aic_df)[colnames(aic_df) == "Modnames"] <- "Model #"

# Write the data frame to a CSV file
write.csv(aic_df, file = "bodysize_spawningpopulation/AICresults_bodysize~SpawningPopulation.csv", row.names = FALSE)

```

### Model Averaging and Parameter Likelihoods
```{r}
# ---- Load necessary packages ----
library(MuMIn)

# List your models (already fit with na.action=na.fail)
models <- list(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10)

# Model averaging based on AICc, conditional averaging (default is full=TRUE)
model_avg <- model.avg(models, rank = "AICc", full = TRUE)

# Summary with coefficients, SE, CIs
summary(model_avg)

# Full averaged coefficients
avg_coefs_full <- coef(model_avg, full = TRUE)

# Full averaged confidence intervals
avg_confint_full <- confint(model_avg, full = TRUE)

# Full averaged variance-covariance matrix and SE
avg_vcov_full <- vcov(model_avg, full = TRUE)
avg_se_full <- sqrt(diag(avg_vcov_full))

# Create tidy data frame with full averages
coefs_df_full <- as.data.frame(avg_coefs_full)
colnames(coefs_df_full) <- "Avg_Coef"
coefs_df_full$CI_Lower <- avg_confint_full[, 1]
coefs_df_full$CI_Upper <- avg_confint_full[, 2]
coefs_df_full$SE <- avg_se_full

# Calculate parameter importance (parameter likelihoods)
param_likelihoods <- sw(model_avg)
as.data.frame(param_likelihoods)

# Manually specify parameter likelihoods from sw(model_avg)
manual_likelihoods <- c(
  "(Intercept)" = 1.0,
  "Gonad_Wt_g" = 1.000000,
  "Collection_LocationGulkana Hatchery" = 0.41159041, 
  "Collection_LocationLong Lake" = 0.41159041,
  "Collection_LocationMahlo" = 0.41159041,
  "Collection_LocationMentasta" = 0.41159041,
  "Collection_LocationSt Anne" = 0.41159041,
  "Collection_LocationTanada" = 0.41159041,
  "Year2020" = 0.96892340,
  "Year2021" = 0.96892340, 
  "SexM" = 1.00000000,
  "SexM:Year2020" = 0.25346865,
  "SexM:Year2021" = 0.25346865,
  "Collection_LocationGulkana Hatchery:SexM" = 0.00140456,
  "Collection_LocationLong Lake:SexM" = 0.00140456,
  "Collection_LocationMahlo:SexM" = 0.00140456,
  "Collection_LocationMentasta:SexM" = 0.00140456,
  "Collection_LocationSt Anne:SexM" = 0.00140456,
  "Collection_LocationTanada:SexM" = 0.00140456
)


# Add ParamLikelihoods by matching rownames
coefs_df_full$ParamLikelihood <- manual_likelihoods[rownames(coefs_df_full)]

# View final table
print(coefs_df_full)

write.csv(coefs_df_full, file = "bodysize_spawningpopulation/bodysize_spawningpopulation_ModelAvg_Coefs_withLikelihoods.csv", row.names = TRUE)

```


### Using summed weighted parameter estimates for body size by CL ~ work (successful size for migration, as continuous variable)
```{r}
# Step 1: Extract intercept
intercept <- coefs_df_full["(Intercept)", "Avg_Coef"]

# Step 2: Extract Collection_Location effects
location_effects <- coefs_df_full[grep("^Collection_Location", rownames(coefs_df_full)), ]
location_effects <- location_effects[!grepl(":", rownames(location_effects)), ]  # remove interaction terms

# Extract location names (remove "Collection_Location" from row names)
location_effects$Location <- gsub("Collection_Location", "", rownames(location_effects))

# Step 3: Add intercept to each to get estimated body size
location_effects$Estimated_BodySize <- intercept + location_effects$Avg_Coef

# Step 4: Add back the reference location (intercept only)
ref_location <- levels(DataSet$Collection_Location)[1]  # Assumes first level is the reference
ref_row <- data.frame(
  Avg_Coef = intercept,
  CI_Lower = coefs_df_full["(Intercept)", "CI_Lower"],
  CI_Upper = coefs_df_full["(Intercept)", "CI_Upper"],
  SE = coefs_df_full["(Intercept)", "SE"],
  ParamLikelihood = coefs_df_full["(Intercept)", "ParamLikelihood"],
  Location = ref_location,
  Estimated_BodySize = intercept
)

# Step 5: Combine
location_estimates <- rbind(ref_row, location_effects)
rownames(location_estimates) <- NULL
location_estimates <- location_estimates[, c("Location", setdiff(names(location_estimates), "Location"))]

# Step 6: Compute average Work per location
install.packages("dplyr")
library(dplyr)

# Check unique values
unique(DataSet$Collection_Location)
avg_work <- DataSet %>%
  dplyr::group_by(Collection_Location) %>%
  dplyr::summarise(Avg_Work = mean(Work, na.rm = TRUE), .groups = "drop")

# Step 7: Merge with estimates
location_estimates <- merge(location_estimates, avg_work, by.x = "Location", by.y = "Collection_Location")

# Step 8: Linear regression of estimated body size ~ work
bodysize_work_model <- lm(Estimated_BodySize ~ Avg_Work, data = location_estimates)
summary(bodysize_work_model)

# Step 9: Visualization
library(ggplot2)
ggplot(location_estimates, aes(x = Avg_Work, y = Estimated_BodySize, label = Location)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  geom_text(nudge_y = 0.05, size = 3) +
  labs(title = "Model-Averaged Estimated Body Size vs. Migration Work",
       x = "Migration Work (kmÂ²)", y = "Estimated Body Size (PC Score)") +
  theme_minimal() + 
   theme(
  plot.title = element_text(size = 16, face = "bold"),
  axis.title.x = element_text(size = 16, face = "bold"),
  axis.title.y = element_text(size = 16, face = "bold"),
  axis.text.x = element_text(size = 16),
  axis.text.y = element_text(size = 16),
  legend.title = element_text(size = 16, face = "bold"),
  legend.text = element_text(size = 16)
)





```

### Calculating actual parameter estimates according to intercept
```{r}
coefs_df_full$Actual_Param <- with(coefs_df_full, 
                                   Avg_Coef + coefs_df_full["(Intercept)", "Avg_Coef"])
coefs_df_full["(Intercept)", "Actual_Param"] <- coefs_df_full["(Intercept)", "Avg_Coef"]
```

### Figure that displays parameter estimates + CI for each parameter in the model set
```{r}
paramestimates_bodysize <- "bodysize_spawningpopulation/bodysize_spawningpopulation_ModelAvg_Coefs_withLikelihoods.csv"

paramestimates_bodysize<-read.csv(paramestimates_bodysize)
str(paramestimates_bodysize)

levels(factor(paramestimates_bodysize$Parameter))
paramestimates_bodysize$Parameter <- factor(paramestimates_bodysize$Parameter, 
                           levels = rev(factor(paramestimates_bodysize$Parameter)))


library(ggplot2)
ggplot(paramestimates_bodysize, aes(x = Avg_Coef, y = Parameter)) + 
  geom_point(size = 3) +  # For the coefficient estimate as dots
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.2) + # Horizontal CI bars
  labs(x = "Parameter Estimate", y = "Parameter") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  theme(axis.title = element_text(size = 24), 
        axis.text = element_text(size = 24))

library(dplyr)
paramestimates_bodysize_filtered <- paramestimates_bodysize %>%
  filter(!Parameter %in% c("Gonad_Wt_g"))  # Filter out specific levels

bodysize_plot <- ggplot(paramestimates_bodysize_filtered, aes(x = Avg_Coef, y = Parameter)) + 
  geom_point(size = 3) +  # For the coefficient estimate as dots
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.2) + # Horizontal CI bars
  labs(x = "Parameter Estimate", y = "Parameter") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  theme(axis.title = element_text(size = 24), 
        axis.text = element_text(size = 24))

ggsave("bodysize_spawningpopulation/BodySize_ParamEstimates_Plot.png", plot=bodysize_plot, height=8, width=12, units="in")
```

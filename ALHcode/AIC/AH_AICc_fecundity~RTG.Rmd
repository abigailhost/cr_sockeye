---
title: "AH_AICc_fecundity~RTG"
author: "Abby Host"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE)
```

#' =====================================================
#' AICc code for Fecundity~RunTimingGroup models
#' =====================================================

### Loading Data
```{r}
rm(list = ls())
library(AICcmodavg)
library(lubridate)
library(ggplot2)

#data loading, use the bodysize_pc data because it will be a variable of interest
lowerriver_bodycomp_PCscores <- "lowerriver_bodycomp_PCscores.csv"

# Import the data. Be sure to check the structure of the data and that R is reading continuous and categorical variables appropriately.
DataSet<-read.csv(lowerriver_bodycomp_PCscores)[,-1]
```

### Removing NAs and subsetting female fish for fecundity
```{r}
### Removing NAs that will mess up levels / model weight
any(is.na(DataSet$Collection_Location))
any(is.na(DataSet$RunTimingGroup))
any(is.na(DataSet$Year))
any(is.na(DataSet$Sex)) # All false

DataSetF <- subset(DataSet, Sex == "F")

```

## Calculating Fecundity for the DataSetF 
```{r}
# values i have for fecundity are # of eggs in a subsample and weight of eggs in a subsample-- so I think best to calculate #/g and then average the three subsamples 

DataSetF$Fecun_num_by_wt1 <- (DataSetF$Fem_Fecun_1_num/DataSetF$Fem_Fecun_1_wt)*(DataSetF$Gonad_Wt * 1000)
#unsure if there is enough of 2 and 3 subsamples to find averages as necessary, so just use the first sub sample here

# View DataSet.
head(DataSetF)
summary(DataSetF)
nrow(DataSetF)
str(DataSetF)

#make response variables factors
DataSetF$RunTimingGroup <- as.factor(DataSetF$RunTimingGroup)
DataSetF$Year<- as.factor(DataSetF$Year)
str(DataSetF) #collection_rivermile_m is numeric
```

### Making Models for fecundity~RunTimingGroup, includes collection location
```{r}
# Models for reference
fecundity_RTG_modelset <- "fecundity_runtiminggroup/fecundity~RunTimingGroup_modelset.csv"

ModelSet<-read.csv(fecundity_RTG_modelset)

model1 <- lm(Fecun_num_by_wt1~1, data=DataSetF)
model2 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc, data=DataSetF)
model3 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + EnergyPDry_1, data=DataSetF)
model4 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + RunTimingGroup, data=DataSetF)
model5 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + Year, data=DataSetF)
model6 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + EnergyPDry_1, data=DataSetF)
model7 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + RunTimingGroup, data=DataSetF)
model8 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + Year, data=DataSetF)
model9 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + EnergyPDry_1 + RunTimingGroup, data=DataSetF)
model10 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + EnergyPDry_1*RunTimingGroup, data=DataSetF)
model11 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + EnergyPDry_1 + Year, data=DataSetF)
model12 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + RunTimingGroup + Year, data=DataSetF)
model13 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + EnergyPDry_1 + RunTimingGroup, data=DataSetF)
model14 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + EnergyPDry_1 + Year, data=DataSetF)
model15 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + RunTimingGroup + Year, data=DataSetF)
model16 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m +  EnergyPDry_1 + RunTimingGroup + Year, data=DataSetF)
model17 <- lm(Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + EnergyPDry_1 + RunTimingGroup + Year, data=DataSetF)

```

### AICc Model Selection
```{r}
AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10, model11, model12, model13, model14, model15, model16, model17)

#table of AIC results
mynames1 <- paste("model", as.character(1:17), sep = "")
models <- list(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10, model11, model12, model13, model14, model15, model16, model17)

# Generate AIC table
myaicc1 <- aictab(models, modnames = mynames1)
print(myaicc1)
# Convert AIC table to a data frame for easier manipulation
aic_df <- as.data.frame(myaicc1)
aic_df$ModelName <- c("Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + Year",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + RunTimingGroup + Year",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + EnergyPDry_1 + Year",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + EnergyPDry_1 + RunTimingGroup + Year",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + RunTimingGroup",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + EnergyPDry_1",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + bodysize_pc + EnergyPDry_1 + RunTimingGroup",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + Year",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + EnergyPDry_1",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + EnergyPDry_1 + Year",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + RunTimingGroup + Year",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + EnergyPDry_1 + RunTimingGroup",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + RunTimingGroup",
                      "Fecun_num_by_wt1~Collection_RiverMile_m +  EnergyPDry_1 + RunTimingGroup + Year",
                      "Fecun_num_by_wt1~Collection_RiverMile_m + EnergyPDry_1*RunTimingGroup",
                      "Fecun_num_by_wt1~1")
colnames(aic_df)[colnames(aic_df) == "Modnames"] <- "Model #"

# Write the data frame to a CSV file
write.csv(aic_df, file = "fecundity_runtiminggroup/AICresults_fecundity~RunTimingGroup.csv", row.names = FALSE)

```

### Model Averaging
```{r}
library(MuMIn)

# List your models (already fit with na.action=na.fail)
models <- list(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10, model11, model12, model13, model14, model15, model16, model17)

# Model averaging based on AICc, conditional averaging (default is full=TRUE)
model_avg <- model.avg(models, rank = "AICc", full = TRUE)

# Summary with coefficients, SE, CIs
summary(model_avg)

# Full averaged coefficients
avg_coefs_full <- coef(model_avg, full = TRUE)

# Full averaged confidence intervals
avg_confint_full <- confint(model_avg, full = TRUE)

# Full averaged variance-covariance matrix and SE
avg_vcov_full <- vcov(model_avg, full = TRUE)
avg_se_full <- sqrt(diag(avg_vcov_full))

# Create tidy data frame with full averages
coefs_df_full <- as.data.frame(avg_coefs_full)
colnames(coefs_df_full) <- "Avg_Coef"
coefs_df_full$CI_Lower <- avg_confint_full[, 1]
coefs_df_full$CI_Upper <- avg_confint_full[, 2]
coefs_df_full$SE <- avg_se_full

# Calculate parameter importance (parameter likelihoods)
param_likelihoods <- sw(model_avg)
as.data.frame(param_likelihoods)

# Manually specify parameter likelihoods from sw(model_avg)
manual_likelihoods <- c(
  "(Intercept)" = 1.0,
  "Collection_RiverMile_m" = 0.9999993039,
  "bodysize_pc" = 0.9831753874, 
  "Year2020" = 0.8934375153,
  "Year2021" = 0.8934375153,
  "RunTimingGroupLate" = 0.3756698911,
  "RunTimingGroupMiddle" = 0.3756698911,
  "EnergyPDry_1" = 0.2578156945, 
  "EnergyPDry_1:RunTimingGroupLate" = 0.0002608785,
  "EnergyPDry_1:RunTimingGroupMiddle" = 0.0002608785
)

# Add ParamLikelihoods by matching rownames
coefs_df_full$ParamLikelihood <- manual_likelihoods[rownames(coefs_df_full)]

# View final table
print(coefs_df_full)

write.csv(coefs_df_full, file = "fecundity_runtiminggroup/fecundity~runtiminggroup_models_CoefEstimates_withLikelihoods.csv", row.names = TRUE)
```
### Calculating actual parameter estimates according to intercept
```{r}
coefs_df_full$Actual_Param <- with(coefs_df_full, 
                                   Avg_Coef + coefs_df_full["(Intercept)", "Avg_Coef"])
coefs_df_full["(Intercept)", "Actual_Param"] <- coefs_df_full["(Intercept)", "Avg_Coef"]
```



### Figure that displays parameter estimates + CI for each parameter in the model set
```{r}
paramestimates_fecundity <- "fecundity_runtiminggroup/fecundity~runtiminggroup_models_CoefEstimates_withLikelihoods.csv"

paramestimates_fecundity<-read.csv(paramestimates_fecundity)
str(paramestimates_fecundity)

levels(factor(paramestimates_fecundity$X))
paramestimates_fecundity$X <- factor(paramestimates_fecundity$X, 
                           levels = rev(factor(paramestimates_fecundity$X)))


library(ggplot2)
ggplot(paramestimates_fecundity, aes(x = Avg_Coef, y = X)) + 
  geom_point(size = 3) +  # For the coefficient estimate as dots
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.2) + # Horizontal CI bars
  labs(x = "Parameter Estimate", y = "Parameter") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  theme_minimal() +
  theme(axis.title = element_text(size = 24), 
        axis.text = element_text(size = 24))

library(dplyr)
paramestimates_fecundity_filtered <- paramestimates_fecundity %>%
  filter(X != "Collection_RiverMile_m")

fecundity_plot <- ggplot(paramestimates_fecundity_filtered, aes(x = Avg_Coef, y = X)) + 
  geom_point(size = 3) +  # For the coefficient estimate as dots
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.2) + # Horizontal CI bars
  labs(x = "Parameter Estimate", y = "Parameter") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  theme(axis.title = element_text(size = 24), 
        axis.text = element_text(size = 24))

ggsave("fecundity_runtiminggroup/Fecundity_ParamEstimates_Plot.png", plot=fecundity_plot, height=12, width=12, units="in")


#egg vs fecundity
ggplot(DataSetF, aes(x = Fem_Egg_Sz_1, y = Fecun_num_by_wt1)) +
  geom_point(size = 5) +
  geom_smooth(method = "lm", se = TRUE, color = "blue")  +
  labs(title = "Fecundity vs. Egg Size",
       x = "Egg Size (mm)", y = "Fecundity") +
  theme_minimal() +
  theme(
  plot.title = element_text(size = 16, face = "bold"),
  axis.title.x = element_text(size = 16, face = "bold"),
  axis.title.y = element_text(size = 16, face = "bold"),
  axis.text.x = element_text(size = 16),
  axis.text.y = element_text(size = 16),
  legend.title = element_text(size = 16, face = "bold"),
  legend.text = element_text(size = 16)
)

#body vs fecundity
ggplot(DataSetF, aes(x = bodysize_pc, y = Fecun_num_by_wt1)) +
  geom_point(size = 5) +
  geom_smooth(method = "lm", se = TRUE, color = "blue")  +
  labs(title = "Fecundity vs. Body Size",
       x = "Body Size (mJ/kg)", y = "Fecundity") +
  theme_minimal() +
  theme(
  plot.title = element_text(size = 16, face = "bold"),
  axis.title.x = element_text(size = 16, face = "bold"),
  axis.title.y = element_text(size = 16, face = "bold"),
  axis.text.x = element_text(size = 16),
  axis.text.y = element_text(size = 16),
  legend.title = element_text(size = 16, face = "bold"),
  legend.text = element_text(size = 16)
)

#fecundity vs energy
ggplot(DataSetF, aes(x = EnergyPDry_1, y = Fecun_num_by_wt1)) +
  geom_point(size = 5) +
  geom_smooth(method = "lm", se = TRUE, color = "blue")  +
  labs(title = "Fecundity vs. Energy",
       x = "Energy (mJ/kg)", y = "Fecundity") +
  theme_minimal() +
  theme(
  plot.title = element_text(size = 16, face = "bold"),
  axis.title.x = element_text(size = 16, face = "bold"),
  axis.title.y = element_text(size = 16, face = "bold"),
  axis.text.x = element_text(size = 16),
  axis.text.y = element_text(size = 16),
  legend.title = element_text(size = 16, face = "bold"),
  legend.text = element_text(size = 16)
)

#energy vs egg size
ggplot(DataSetF, aes(x = EnergyPDry_1, y = Fem_Egg_Sz_1)) +
  geom_point(size = 5) +
  geom_smooth(method = "lm", se = TRUE, color = "blue")  +
  labs(title = "Egg Size vs. Energy",
       x = "Energy (mJ/kg)", y = "Egg Size") +
  theme_minimal() +
  theme(
  plot.title = element_text(size = 16, face = "bold"),
  axis.title.x = element_text(size = 16, face = "bold"),
  axis.title.y = element_text(size = 16, face = "bold"),
  axis.text.x = element_text(size = 16),
  axis.text.y = element_text(size = 16),
  legend.title = element_text(size = 16, face = "bold"),
  legend.text = element_text(size = 16)
)

#body size vs egg size
ggplot(DataSetF, aes(x = bodysize_pc, y = Fem_Egg_Sz_1)) +
  geom_point(size = 5) +
  geom_smooth(method = "lm", se = TRUE, color = "blue")  +
  labs(title = "Egg Size vs. Body Size",
       x = "Body Size (PC1)", y = "Egg Size") +
  theme_minimal() +
  theme(
  plot.title = element_text(size = 16, face = "bold"),
  axis.title.x = element_text(size = 16, face = "bold"),
  axis.title.y = element_text(size = 16, face = "bold"),
  axis.text.x = element_text(size = 16),
  axis.text.y = element_text(size = 16),
  legend.title = element_text(size = 16, face = "bold"),
  legend.text = element_text(size = 16)
)

```

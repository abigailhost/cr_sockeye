---
title: "AH_AICc_fineness~RTG"
author: "Abby Host"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE)
```


### Checking for NAs for PC score
```{r, echo=TRUE, results='hide', warning=FALSE, message=FALSE}
rm(list = ls())
DataSet <- read.csv("lowerriver_GSI_PCscores.csv")
str(DataSet)
DataSet$Fish_Wdth_mm <- DataSet$Fish_Wdth * 10
str(DataSet)

#eliminate unnecessary group assignments
# Standardize levels
DataSet$Group_Assignment <- factor(DataSet$Group_Assignment)
levels(DataSet$Group_Assignment)


# Clean up levels manually
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "Gulkana "] <- "Gulkana"
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "Gulkanahatchery"] <- "GulkanaHatchery"
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "KlutinaTonsinaOutlets"] <- "KlutinaTonsinaOutlet"
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "insufficient genotypes"] <- "insufficient_genotypes"

# Then drop the insufficient genotypes
DataSet <- subset(DataSet, Group_Assignment != "insufficient_genotypes")
DataSet <- subset(DataSet, Group_Assignment != "LowerGroups")
DataSet$Group_Assignment <- droplevels(DataSet$Group_Assignment)

# Confirm new levels
levels(DataSet$Group_Assignment)


#check width values to determine if need to estimate
any(is.na(DataSet$Fish_Wdth_mm)) #False, so have all width values I need

```

### Adding Fineness Ratio for lowerriver_bodycomp_all
```{r}
### Fineness Ratio = A fish's "fineness ratio" refers to the ratio of its body length to its maximum cross-sectional diameter

#Need to calculate fineness according to sex
library(dplyr)
# Fineness Ratio 2: fish length / fish width, dependent on sex
DataSet <- DataSet %>%
  group_by(Sex) %>%
  mutate(fineness = Fish_Leng_1_mm / Fish_Wdth_mm)

str(DataSet$fineness) #fineness_2 is numeric

# View the mean fineness ratio by sex
mean_fineness <- DataSet %>%
  group_by(Sex) %>%
  summarise(mean_fineness = mean(fineness, na.rm = TRUE))

print(mean_fineness)

# Create new data file that includes fineness data in the dataset for models
write.csv(DataSet, "lowerriver_bodycomp_fineness.csv")


```

### Import Data for models
```{r, echo=TRUE, results='hide', warning=FALSE, message=FALSE}
rm(list = ls())
lowerriver_bodycomp_fineness <- "lowerriver_bodycomp_fineness.csv"

# Import the data. Be sure to check the structure of the data and that R is reading continuous and categorical variables appropriately.
DataSet<-read.csv(lowerriver_bodycomp_fineness)[,-1]

# View DataSet.
head(DataSet)
summary(DataSet)
nrow(DataSet)
str(DataSet)

#make response variables factors
DataSet$Group_Assignment <- as.factor(DataSet$Group_Assignment) 
DataSet$RunTimingGroup <- as.factor(DataSet$RunTimingGroup)
DataSet$Year<- as.factor(DataSet$Year)
DataSet$Sex<- as.factor(DataSet$Sex)
str(DataSet)

mean(DataSet$fineness)



# ======================== Figures for fineness ratio ==========================
str(DataSet)

DataSet$RunTimingGroup <- factor(DataSet$RunTimingGroup,
                             levels = c("Early",
                                        "Middle",
                                        "Late"))

library(ggplot2)
ggplot(DataSet, aes(x = RunTimingGroup, y = fineness, fill = RunTimingGroup)) +
  geom_boxplot() + 
  stat_summary(fun = mean, geom = "text", aes(label = round(..y.., 2)), 
               color = "black", size = 4) 
#Shapes that are short and wide have a low fineness ratio, those that are long and narrow have high fineness ratios.

levels(DataSet$Group_Assignment)

DataSet$Group_Assignment <- factor(DataSet$Group_Assignment,
                             levels = c("KlutinaTonsinaOutlet",
                                        "KlutinaLake",
                                        "Chitina",
                                        "TanadaCopperLakes",
                                        "Gulkana",
                                        "Slana",
                                        "Tazlina",
                                        "Bremner",
                                        "GulkanaHatchery"))

colors_GSI <- c(
  "Bremner" = "#E0B300",   
  "Chitina" = "#FFE5CCFF", #"black" if need to remove 
  "Gulkana" = "#A50021FF",   
  "GulkanaHatchery" = "#D32826FF", #black when need to remove when included 
  "Tazlina" = "#FF5C5C",   # reddish
  "Slana" = "#CC5800FF",
  "KlutinaLake" = "#FF8E32FF", 
  "KlutinaTonsinaOutlet" = "#E56B00", 
  "TanadaCopperLakes" = "#993F00FF")

ggplot(DataSet, aes(x = Group_Assignment, y = fineness, fill = Group_Assignment)) +
  geom_boxplot() + 
  stat_summary(fun = mean, geom = "text", aes(label = round(..y.., 2)), 
               color = "black", size = 4) +
  scale_fill_manual(values = colors_GSI)

library(lubridate)
DataSet$JulianDay <- yday(DataSet$Collection_Date)

ggplot(DataSet, aes(x = JulianDay, 
                    y = fineness,
                    color = Group_Assignment)) +   # <-- move it here
  geom_point(size = 3) +
  labs(x = "Collection Date",
       y = "Fineness",
       color = "Group Assignment") + # adds legend title
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = colors_GSI) +
  facet_wrap(~Year, scales = "free_x") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```



### Fineness in Upper River
```{r}
DataSet <- read.csv("upperriver_bodycomp_PCscores.csv")
#checking NA
any(is.na(DataSet$Fish_Leng_1_mm))
any(is.na(DataSet$Fish_Ht_mm))
any(is.na(DataSet$Fish_Grth_mm)) #No NA's
any(is.na(DataSet$Fish_Wdth)) #True, need to determine how many values
DataSet[is.na(DataSet$Fish_Wdth), ] #12 rows need to be filled in

DataSet$Fish_Wdth_mm <- DataSet$Fish_Wdth*10


# Subset the data for female F fish only
DataSetF <- DataSet[DataSet$Sex == "F", ]

summary(lm(Fish_Wdth_mm ~ bodysize_pc_g_mm, data = DataSetF)) #R = 0.4102
summary(lm(Fish_Wdth_mm ~ Fish_Wt_g, data = DataSetF)) #R =  0.5268, so use this for predicting
summary(lm(Fish_Wdth_mm ~ Fish_Grth_mm, data = DataSetF)) # Adjusted R-squared:  0.4942


width_F_lm <- lm(Fish_Wdth_mm ~ Fish_Wt_g, data = DataSetF)
summary(width_F_lm) # R squared  0.6396
plot(width_F_lm)


predicted_values_widthF_mm <- predict(width_F_lm, newdata = DataSetF)

DataSetF$Predicted_Fish_Wdth_mm <- predicted_values_widthF_mm # Add these predictions back to your dataset


ggplot(DataSetF, aes(x = Predicted_Fish_Wdth_mm, y = Fish_Wdth_mm)) +
  geom_point(aes(color = "Observed")) +
  geom_point(aes(y = Predicted_Fish_Wdth_mm, color = "Predicted")) +
  scale_color_manual(values = c("Observed" = "blue", "Predicted" = "red")) +
  labs(title = "Observed vs Predicted Female Fish",
       x = "Predicted Fish Width",
       y = "Fish Width") +
  theme_minimal() 

# Replace NAs in Fish_Wdth_mm with predicted values
DataSetF$Fish_Wdth_mm[is.na(DataSetF$Fish_Wdth_mm)] <- DataSetF$Predicted_Fish_Wdth_mm[is.na(DataSetF$Fish_Wdth_mm)]
## so now, the female subset has predicted values replacing the NAs for Wdth



#Now, same for the male data
DataSetM <- DataSet[DataSet$Sex == "M", ] #subset of M from total data set

Wdth_M_lm <- lm(Fish_Wdth_mm ~ Fish_Wt_g, data = DataSetM) #making linear regression
summary(Wdth_M_lm) 
plot(Wdth_M_lm)
predicted_values_WdthM_mm <- predict(Wdth_M_lm, newdata = DataSetM) #predicting width values from male subset data
DataSetM$Predicted_Fish_Wdth_mm <- predicted_values_WdthM_mm

ggplot(DataSetM, aes(x = Predicted_Fish_Wdth_mm, y = Fish_Wdth_mm)) +
  geom_point(aes(color = "Observed")) +
  geom_point(aes(y = Predicted_Fish_Wdth_mm, color = "Predicted")) +
  scale_color_manual(values = c("Observed" = "blue", "Predicted" = "red")) +
  labs(title = "Observed vs Predicted Male Fish Width",
       x = "Predicted Fish Width",
       y = "Fish Width") +
  theme_minimal() 

# Replace NAs in Fish_Leng_1 with predicted values
DataSetM$Fish_Wdth_mm[is.na(DataSetM$Fish_Wdth_mm)] <- DataSetM$Predicted_Fish_Wdth_mm[is.na(DataSetM$Fish_Wdth_mm)]
## so now, the male subset has predicted values replacing the NAs 

DataSet <- rbind(DataSetM, DataSetF)


### Calculating Upper River Fineness
DataSet <- DataSet %>%
  group_by(Sex) %>%
  mutate(fineness = Fish_Leng_1_mm / Fish_Wdth_mm)

str(DataSet$fineness) 


# Create new data file that includes fineness data in the upper river fish
write.csv(DataSet, "upperriver_bodycomp_fineness.csv")


# =============== Plotting Fineness Ratio for Upper River =======================
DataSet$Collection_Location <- factor(DataSet$Collection_Location)
levels(DataSet$Collection_Location)


DataSet$Collection_Location <- factor(DataSet$Collection_Location,
                             levels = c("Long Lake",
                                        "St Anne",
                                        "Mahlo",
                                        "Mentasta",
                                        "Tanada",
                                        "Gulkana Hatchery",
                                        "Fish Creek Gulkana"))

colors_SP <- c(
  "Long Lake" = "#FFE5CCFF", #black when not included
  "Fish Creek Gulkana" = "#A50021FF",   
  "Gulkana Hatchery" = "#D82632FF", 
  "St Anne" = "#FFAD65FF",   # reddish
  "Mahlo" = "#FF8E32FF",
  "Mentasta" = "#CC5800FF", 
  "Tanada" = "#993F00FF")

library(ggplot2)
ggplot(DataSet, aes(x = Collection_Location, y = fineness, fill = Collection_Location)) +
  geom_boxplot() + 
  stat_summary(fun = mean, geom = "text", aes(label = round(..y.., 2)), 
               color = "black", size = 4) +
  scale_fill_manual(values = colors_SP)
#Shapes that are short and wide have a low fineness ratio, those that are long and narrow have high fineness ratios.



```

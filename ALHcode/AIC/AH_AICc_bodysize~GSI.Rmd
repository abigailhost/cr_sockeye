---
title: "AH_AICc_bodysize~GSI"
author: "Abby Host"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE)
```

#' =====================================================
#' AICc code for BodySizePC_1~GSI models
#' =====================================================


NOTE!!!! Need to ensure what level of assignment likelihood we are using for inclusion in GSI analysis!

### Loading Data
```{r}
rm(list = ls())
library(AICcmodavg)
library(lubridate)
library(ggplot2)

#data loading
gsi20 <- read.csv("GSI_lowerriver20.csv")[,-1]
gsi21 <- read.csv("GSI_lowerriver21.csv")
#need to bind all together for total body comp GSI dataset, lower river only

gsi_LR_total <- rbind(gsi20[1:60,], gsi21[1:60,])
write.csv(gsi_LR_total, "lowerriver_GSI_all.csv")
lowerriver_GSI_all<-read.csv("lowerriver_GSI_all.csv")[,-1]
#all data is loaded now
#Year already included as a variable/column

#replace blank cell in Sex with NA 
lowerriver_GSI_all$Sex[lowerriver_GSI_all$Sex == ""] <- NA
str(lowerriver_GSI_all)

write.csv(lowerriver_GSI_all, "lowerriver_GSI_all.csv")

```

### Checking for NAs for PC score
```{r}
rm(list = ls())
lowerriver_GSI_all <- "lowerriver_GSI_all.csv"
lowerriver_GSI_all<-read.csv("lowerriver_GSI_all.csv")[,-1]

### Removing NAs that will mess up levels / model weight
any(is.na(lowerriver_GSI_all$Collection_Location))
any(is.na(lowerriver_GSI_all$Group_Assignment))
any(is.na(lowerriver_GSI_all$Year))
any(is.na(lowerriver_GSI_all$Sex))
lowerriver_GSI_all[is.na(lowerriver_GSI_all$Sex), ] #row 55 has no sex value, eliminate it for models
lowerriver_GSI_all <- lowerriver_GSI_all[-55,] #excludes row missing sex file
any(is.na(lowerriver_GSI_all$Sex))

#checking NA
any(is.na(lowerriver_GSI_all$Fish_Leng_2))
any(is.na(lowerriver_GSI_all$Fish_Ht))
any(is.na(lowerriver_GSI_all$Fish_Grth)) #Na's present, will need to omit them for PC score
lowerriver_GSI_all[is.na(lowerriver_GSI_all$Fish_Grth), ] #row 4 has NA, can estimate for PC score

```

### Estimate Girth Values for NA rows
```{r}
ggplot(lowerriver_GSI_all, aes(x=Fish_Leng_1, y = Fish_Grth)) + 
  geom_point() #length relationship to girth, one major outlier, eliminate that point(?) in row 67

lowerriver_GSI_all <- lowerriver_GSI_all[-67,]

ggplot(lowerriver_GSI_all, aes(x=Fish_Leng_1, y = Fish_Grth)) + 
  geom_point() #length relationship to girth, no more outliers

girth_leng_lm <- lm(Fish_Grth ~ Fish_Leng_1, data = lowerriver_GSI_all)
summary(girth_leng_lm) # Adjusted R-squared:  0.6951

# Subset the data for female F fish only
allfemale_lowerriver_GSI_all <- lowerriver_GSI_all[lowerriver_GSI_all$Sex == "F", ]

# Perform PCA on the subset of female F fish
pca_model_allF <- princomp(allfemale_lowerriver_GSI_all[,c(12,14,16)], cor=T, scores=T, covmat = NULL)

summary(pca_model_allF, loadings=T, cutoff=0.001) #summary of PC analysis

# Create a new dataframe with PCA scores for the female F fish subset
allfemale_lowerriver_bodycomp <- cbind(allfemale_lowerriver_GSI_all, pca_model_allF$scores[, 1])  # First principal component

# Create the linear model for predicting Fish_Grth based on the first principal component
girth_pc_lm <- lm(Fish_Grth ~ pca_model_allF$scores[, 1], data = allfemale_lowerriver_bodycomp)

# View the summary of the linear model
summary(girth_pc_lm)
plot(girth_pc_lm)


predicted_values <- predict(girth_pc_lm, newdata = allfemale_lowerriver_bodycomp)

allfemale_lowerriver_bodycomp$Predicted_Fish_Grth <- predicted_values # Add these predictions back to your dataset

### the predicted value for row 64 when all female fish is Fish_Grth = 30.57211

#plot the original data and the predicted values to see how well the model fits
ggplot(allfemale_lowerriver_bodycomp, aes(x = Predicted_Fish_Grth, y = Fish_Grth)) +
  geom_point(aes(color = "Observed")) +
  geom_point(aes(y = Predicted_Fish_Grth, color = "Predicted")) +
  scale_color_manual(values = c("Observed" = "blue", "Predicted" = "red")) +
  labs(title = "Observed vs Predicted Fish Growth",
       x = "Comparison PC",
       y = "Fish Growth") +
  theme_minimal() 

###### Now, back to using lowerriver_bodycomp_all #######
lowerriver_GSI_all$Fish_Grth[is.na(lowerriver_GSI_all$Fish_Grth)] <- 30.57211
any(is.na(lowerriver_GSI_all$Fish_Leng_1))
any(is.na(lowerriver_GSI_all$Fish_Ht))
any(is.na(lowerriver_GSI_all$Fish_Grth)) # no longer an NA present
```

### PC Score for Body Size, using leng_1, height, girth
```{r}
bc_pca1 <- princomp(lowerriver_GSI_all[,c(12,16,19)], cor=T, scores=T, covmat = NULL) #should work now without any NAs
summary(bc_pca1, loadings=T, cutoff=0.0001) #summary of PC analysis
bc_pca1$scores
screeplot(bc_pca1, type=c('lines'))
bodysize_pc <- bc_pca1$scores[,1]


## Convert leng_1, Ht, and Grth -- for bodysize_pc_g_mm
lowerriver_GSI_all$Fish_Leng_1_mm <- lowerriver_GSI_all$Fish_Leng_1*10
lowerriver_GSI_all$Fish_Ht_mm <- lowerriver_GSI_all$Fish_Ht*10
lowerriver_GSI_all$Fish_Grth_mm <- lowerriver_GSI_all$Fish_Grth*10

bc_pca2 <- princomp(lowerriver_GSI_all[,c(84,85,86)], cor=T, scores=T, covmat = NULL) #should work now without any NAs, identical scores to that of the one above.  units do not matter!
summary(bc_pca2, loadings=T, cutoff=0.0001) #summary of PC analysis
bc_pca2$scores
screeplot(bc_pca2, type=c('lines'))
bodysize_pc_g_mm <- bc_pca2$scores[,1]

#combine dataframe with column for body size PC scores
lowerriver_GSI_pc <- cbind(lowerriver_GSI_all, bodysize_pc, bodysize_pc_g_mm) #So, worth noting that despite conversion, the PC score is exactly the same




#Now, run AIC again but PC1 scores are the response variable / numeric
write.csv(lowerriver_GSI_pc, "lowerriver_GSI_PCscores.csv")
```


### Import Data for models
```{r}
rm(list = ls())
lowerriver_GSI_PCscores <- "lowerriver_GSI_PCscores.csv"

# Import the data. Be sure to check the structure of the data and that R is reading continuous and categorical variables appropriately.
DataSet<-read.csv(lowerriver_GSI_PCscores)[,-1] #88 variables, 118 observations b/c one row with NA sex is removed

#### CHECK DIRECTION OF PC SCORE ###
library(ggplot2)
ggplot(DataSet, aes(x=Fish_Leng_1, y=bodysize_pc_g_mm)) +
  geom_point()
#so direction of PC score is positive, can check with other variables

#make response variables factors
DataSet$Collection_Location <- as.factor(DataSet$Collection_Location)
DataSet$Group_Assignment <- as.factor(DataSet$Group_Assignment)
levels(DataSet$Group_Assignment) #levels are not all consistent. Need to fix this

# Strip whitespace
DataSet$Group_Assignment <- trimws(DataSet$Group_Assignment)

# Standardize levels
DataSet$Group_Assignment <- factor(DataSet$Group_Assignment)
levels(DataSet$Group_Assignment)


# Clean up levels manually
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "Gulkana "] <- "Gulkana"
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "Gulkanahatchery"] <- "GulkanaHatchery"
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "KlutinaTonsinaOutlets"] <- "KlutinaTonsinaOutlet"
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "insufficient genotypes"] <- "insufficient_genotypes"

# Then drop the insufficient genotypes
DataSet <- subset(DataSet, Group_Assignment != "insufficient_genotypes")
DataSet$Group_Assignment <- droplevels(DataSet$Group_Assignment)


# Confirm new levels
levels(DataSet$Group_Assignment)


DataSet$Year<- as.factor(DataSet$Year)
DataSet$Sex<- as.factor(DataSet$Sex)
str(DataSet) #collection_rivermile_m is numeric

```

### Making Models for bodysize_pc~GSI,
```{r}
# Models for reference
bodysize_GSI_modelset <- "bodysize_GSI/bodysize~GSI_modelset.csv"

ModelSet<-read.csv(bodysize_GSI_modelset)

model1 <- lm(bodysize_pc_g_mm~1, data=DataSet)
model2 <- lm(bodysize_pc_g_mm~Collection_RiverMile_m + Group_Assignment, data = DataSet)
model3 <- lm(bodysize_pc_g_mm~Collection_RiverMile_m + Sex, data = DataSet)
model4 <- lm(bodysize_pc_g_mm~Collection_RiverMile_m + Group_Assignment + Sex, data = DataSet)

```

### AICc Model Selection
```{r}
AIC(model1, model2, model3, model4)

#table of AIC results
mynames1 <- paste("model", as.character(1:4), sep = "")
models <- list(model1, model2, model3, model4)

# Generate AIC table
myaicc1 <- aictab(models, modnames = mynames1)
print(myaicc1)
# Convert AIC table to a data frame for easier manipulation
aic_df <- as.data.frame(myaicc1)
aic_df$ModelName <- c("bodysize_pc_g_mm~Collection_RiverMile_m + Sex",
                      "bodysize_pc_g_mm~Collection_RiverMile_m + Group_Assignment + Sex",
                      "bodysize_pc_g_mm~Collection_RiverMile_m + Group_Assignment",
                      "bodysize_pc_g_mm~1")


colnames(aic_df)[colnames(aic_df) == "Modnames"] <- "Model #"

# Write the data frame to a CSV file
write.csv(aic_df, file = "bodysize_GSI/AICresults_bodysize~GSI.csv", row.names = FALSE)


```



### Model Averaging
```{r}
library(MuMIn)

# List your models (already fit with na.action=na.fail)
models <- list(model1, model2, model3, model4)

# Model averaging based on AICc, conditional averaging (default is full=TRUE)
model_avg <- model.avg(models, rank = "AICc", full = TRUE)

# Summary with coefficients, SE, CIs
summary(model_avg)

# Full averaged coefficients
avg_coefs_full <- coef(model_avg, full = TRUE)

# Full averaged confidence intervals
avg_confint_full <- confint(model_avg, full = TRUE)

# Full averaged variance-covariance matrix and SE
avg_vcov_full <- vcov(model_avg, full = TRUE)
avg_se_full <- sqrt(diag(avg_vcov_full))

# Create tidy data frame with full averages
coefs_df_full <- as.data.frame(avg_coefs_full)
colnames(coefs_df_full) <- "Avg_Coef"
coefs_df_full$CI_Lower <- avg_confint_full[, 1]
coefs_df_full$CI_Upper <- avg_confint_full[, 2]
coefs_df_full$SE <- avg_se_full

# Calculate parameter importance (parameter likelihoods)
param_likelihoods <- sw(model_avg)
as.data.frame(param_likelihoods)

# Manually specify parameter likelihoods from sw(model_avg)
manual_likelihoods <- c(
  "(Intercept)" = 1.0,
  "Collection_RiverMile_m" = 0.1658772,
  "Group_AssignmentChitina" = 0.1658772,
  "Group_AssignmentGulkana" = 0.1658772,
  "Group_AssignmentGulkanaHatchery" = 0.1658772,
  "Group_AssignmentKlutinaLake" = 0.1658772,
  "Group_AssignmentKlutinaTonsinaOutlet" = 0.1658772,
  "Group_AssignmentLowerGroups" = 0.1658772,
  "Group_AssignmentSlana" = 0.1658772,
  "Group_AssignmentTanadaCopperLakes" = 0.1658772,
  "Group_AssignmentTazlina" = 0.1658772,
  "SexM" = 0.9629617
)



# Add ParamLikelihoods by matching rownames
coefs_df_full$ParamLikelihood <- manual_likelihoods[rownames(coefs_df_full)]

# View final table
print(coefs_df_full)

write.csv(coefs_df_full, file = "bodysize_GSI/bodysize_GSI_ModelAvg_Coefs_withLikelihoods.csv", row.names = TRUE)

```

### Estimates Figure
```{r}
# Figure that displays parameter estimates + CI for each parameter in teh model set
paramestimates_bodyGSI <- "bodysize_GSI/bodysize_GSI_ModelAvg_Coefs_withLikelihoods.csv"

estimates_body<-read.csv(paramestimates_bodyGSI)
str(estimates_body)

levels(factor(estimates_body$X))
estimates_body$X <- factor(estimates_body$X, 
                           levels = rev(c("(Intercept)",
                                          "Collection_RiverMile_m",
                                          "SexM",
                                          "Year2021",
                                          "Group_AssignmentChitina", 
                                          "Group_AssignmentGulkana",
                                          "Group_AssignmentGulkanaHatchery",
                                          "Group_AssignmentKlutinaLake",
                                          "Group_AssignmentKlutinaTonsinaOutlet",
                                          "Group_AssignmentLowerGroups",
                                          "Group_AssignmentSlana",
                                          "Group_AssignmentTanadaCopperLakes",
                                          "Group_AssignmentTazlina",
                                          "Group_AssignmentChitina:SexM",
                                          "Group_AssignmentGulkana:SexM",
                                          "Group_AssignmentGulkanaHatchery:SexM",
                                          "Group_AssignmentKlutinaLake:SexM",
                                          "Group_AssignmentKlutinaTonsinaOutlet:SexM",
                                          "Group_AssignmentLowerGroups:SexM",
                                          "Group_AssignmentSlana:SexM",
                                          "Group_AssignmentTanadaCopperLakes:SexM",
                                          "Group_AssignmentTazlina:SexM",
                                          "SexM:Year2021")))



ggplot(estimates_body, aes(x = Avg_Coef, y = X)) + 
  geom_point(size = 3) +  # For the coefficient estimate as dots
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.2) + # Horizontal CI bars
  labs(x = "Parameter Estimate", y = "Parameter") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  theme(axis.title = element_text(size = 24), 
        axis.text = element_text(size = 24))



```

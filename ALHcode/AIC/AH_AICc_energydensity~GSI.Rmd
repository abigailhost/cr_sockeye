---
title: "AH_AICc_energydensity~GSI"
author: "Abby Host"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE)
```

#' =====================================================
#' AICc code for EnergyPDry_1~GSI models
#' =====================================================


NOTE!!!! Need to ensure what level of assignment likelihood we are using for inclusion in GSI analysis!

### Loading Data
```{r}
rm(list = ls())
library(AICcmodavg)
library(lubridate)
library(ggplot2)

#data loading
# gsi20 <- read.csv("GSI_lowerriver20.csv")[,-1]
# gsi21 <- read.csv("GSI_lowerriver21.csv")
#need to bind all together for total body comp GSI dataset, lower river only

# gsi_LR_total <- rbind(gsi20[1:60,], gsi21[1:60,])
# write.csv(gsi_LR_total, "lowerriver_GSI_all.csv")
lowerriver_GSI_all<-read.csv("lowerriver_GSI_all.csv")[,-1]
#all data is loaded now
#Year already included as a variable/column

#replace blank cell in Sex with NA 
lowerriver_GSI_all$Sex[lowerriver_GSI_all$Sex == ""] <- NA
str(lowerriver_GSI_all)

write.csv(lowerriver_GSI_all, "lowerriver_GSI_all.csv")

```

### Import Data for models
```{r}
rm(list = ls())
lowerriver_GSI_all <- "lowerriver_GSI_all.csv"

# Import the data. Be sure to check the structure of the data and that R is reading continuous and categorical variables appropriately.
DataSet<-read.csv(lowerriver_GSI_all)[,-1] #84 variables, 120 observations b/c one row with NA sex is removed


### Removing NAs that will mess up levels / model weight
any(is.na(DataSet$Collection_Location))
any(is.na(DataSet$Group_Assignment))
any(is.na(DataSet$Year))
any(is.na(DataSet$Sex))
DataSet[is.na(DataSet$Sex), ] #row 55 has no sex value, eliminate it for models
DataSet <- DataSet[-55,] #excludes row missing sex file
any(is.na(DataSet$Sex)) 

# View DataSet.
head(DataSet)
summary(DataSet)
nrow(DataSet)
str(DataSet)

#make response variables factors
DataSet$Collection_Location <- as.factor(DataSet$Collection_Location)
DataSet$Group_Assignment <- as.factor(DataSet$Group_Assignment)
levels(DataSet$Group_Assignment) #levels are not all consistent. Need to fix this

# Strip whitespace
DataSet$Group_Assignment <- trimws(DataSet$Group_Assignment)

# Standardize levels
DataSet$Group_Assignment <- factor(DataSet$Group_Assignment)
levels(DataSet$Group_Assignment)


# Clean up levels manually
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "Gulkana "] <- "Gulkana"
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "Gulkanahatchery"] <- "GulkanaHatchery"
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "KlutinaTonsinaOutlets"] <- "KlutinaTonsinaOutlet"
levels(DataSet$Group_Assignment)[levels(DataSet$Group_Assignment) == "insufficient genotypes"] <- "insufficient_genotypes"

# Then drop the insufficient genotypes
DataSet <- subset(DataSet, Group_Assignment != "insufficient_genotypes")
DataSet <- subset(DataSet, Group_Assignment != "LowerGroups")
DataSet$Group_Assignment <- droplevels(DataSet$Group_Assignment) #105 observations, 84 variables, 9 group assignments

# Confirm new levels
levels(DataSet$Group_Assignment)


DataSet$Year<- as.factor(DataSet$Year)
DataSet$Sex<- as.factor(DataSet$Sex)
str(DataSet) #collection_rivermile_m is numeric

```

### Making Models for EnergyPDry_1~GSI,
```{r}
# Models for reference
energydensity_GSI_modelset <- "energydensity_GSI/EnergyPDry_1~GSI_modelset.csv"

ModelSet<-read.csv(energydensity_GSI_modelset)

model1 <- lm(EnergyPDry_1~1, data=DataSet)
model2 <- lm(EnergyPDry_1~Collection_RiverMile_m + Group_Assignment, data = DataSet)
model3 <- lm(EnergyPDry_1~Collection_RiverMile_m + Sex, data = DataSet)
model4 <- lm(EnergyPDry_1~Collection_RiverMile_m + Group_Assignment + Sex, data = DataSet)


```

### AICc Model Selection
```{r}
AIC(model1, model2, model3, model4)

#table of AIC results
mynames1 <- paste("model", as.character(1:4), sep = "")
models <- list(model1, model2, model3, model4)

# Generate AIC table
myaicc1 <- aictab(models, modnames = mynames1)
print(myaicc1)
# Convert AIC table to a data frame for easier manipulation
aic_df <- as.data.frame(myaicc1)
aic_df$ModelName <- c("EnergyPDry_1~Collection_RiverMile_m + Group_Assignment",
                      "EnergyPDry_1~Collection_RiverMile_m + Group_Assignment + Sex",
                      "EnergyPDry_1~Collection_RiverMile_m + Sex",
                      "EnergyPDry_1~1")


colnames(aic_df)[colnames(aic_df) == "Modnames"] <- "Model #"

# Write the data frame to a CSV file
write.csv(aic_df, file = "energydensity_GSI/AICresults_EnergyPDry_1~GSI.csv", row.names = FALSE)


```

### Model Averaging and Parameter Likelihoods
```{r}
library(MuMIn)

# List your models (already fit with na.action=na.fail)
models <- list(model1, model2, model3, model4)

# Model averaging based on AICc, conditional averaging (default is full=TRUE)
model_avg <- model.avg(models, rank = "AICc", full = TRUE)

# Summary with coefficients, SE, CIs
summary(model_avg)

# Full averaged coefficients
avg_coefs_full <- coef(model_avg, full = TRUE)

# Full averaged confidence intervals
avg_confint_full <- confint(model_avg, full = TRUE)

# Full averaged variance-covariance matrix and SE
avg_vcov_full <- vcov(model_avg, full = TRUE)
avg_se_full <- sqrt(diag(avg_vcov_full))

# Create tidy data frame with full averages
coefs_df_full <- as.data.frame(avg_coefs_full)
colnames(coefs_df_full) <- "Avg_Coef"
coefs_df_full$CI_Lower <- avg_confint_full[, 1]
coefs_df_full$CI_Upper <- avg_confint_full[, 2]
coefs_df_full$SE <- avg_se_full

# Calculate parameter importance (parameter likelihoods)
param_likelihoods <- sw(model_avg)
as.data.frame(param_likelihoods)

# Manually specify parameter likelihoods from sw(model_avg)
manual_likelihoods <- c(
  "(Intercept)" = 1.0,
  "Collection_RiverMile_m" = 1.0000000,
  "Group_AssignmentChitina" = 0.9978756,
  "Group_AssignmentGulkana" = 0.9978756,
  "Group_AssignmentGulkanaHatchery" = 0.9978756,
  "Group_AssignmentKlutinaLake" = 0.9978756,
  "Group_AssignmentKlutinaTonsinaOutlet" = 0.9978756,
  "Group_AssignmentSlana" = 0.9978756,
  "Group_AssignmentTanadaCopperLakes" = 0.9978756,
  "Group_AssignmentTazlina" = 0.9978756,
  "SexM" = 0.5006762	)

# Add ParamLikelihoods by matching rownames
coefs_df_full$ParamLikelihood <- manual_likelihoods[rownames(coefs_df_full)]

# View final table
print(coefs_df_full)

write.csv(coefs_df_full, "energydensity_GSI/EnergyPDry_1_GSI_ModelAvg_Coefs_withLikelihoods.csv", row.names = TRUE)


# ---- Step 10: Table for coefficients and threshold for parameter likelihoods ----
# threshold <- 0.1  # Set threshold for importance

# Add a new column to coefs_df that marks important vs non-important parameters
# coefs_df$Importance <- ifelse(coefs_df$ParamLikelihood > threshold, "Important", "Non-Important")

# ---- Color Code Important Parameters with Color Blind Friendly Colors ----
# Light green for important, light gray for non-important
# library(kableExtra)

# Create the table without adding duplicate headers
# coefs_table <- coefs_df %>%
 #  arrange(desc(ParamLikelihood)) %>%
  # kable("html", escape = FALSE, align = c("l", "r", "r", "r", "r", "r", "l")) %>%
  # Apply color coding based on importance
 #  kable_styling(bootstrap_options = c("striped", "hover")) %>%
 # = row_spec(which(coefs_df$Importance == "Important"), background = "lightgreen", color = "black") %>%
  # row_spec(which(coefs_df$Importance == "Non-Important"), background = "lightgray", color = "black") # Adjust column width if needed

# Print or save the table
# coefs_table

```
### Using summed weighted parameter estimates for energy density by GSI ~ work (successful size for migration, as continuous variable)
```{r}
# Step 1: Extract intercept
intercept <- coefs_df_full["(Intercept)", "Avg_Coef"]

# Step 2: Extract Group_Assignment effects
GSI_effects <- coefs_df_full[grep("^Group_Assignment", rownames(coefs_df_full)), ]
GSI_effects <- GSI_effects[!grepl(":", rownames(GSI_effects)), ]  # remove interaction terms

# Extract location names (remove "Collection_Location" from row names)
GSI_effects$GSI <- gsub("Group_Assignment", "", rownames(GSI_effects))

# Step 3: Add intercept to each to get estimated body size
GSI_effects$Estimated_EnergyDensity <- intercept + GSI_effects$Avg_Coef

# Step 4: Add back the reference location (intercept only)
ref_location <- levels(DataSet$Group_Assignment)[1]  # Assumes first level is the reference
ref_row <- data.frame(
  Avg_Coef = intercept,
  CI_Lower = coefs_df_full["(Intercept)", "CI_Lower"],
  CI_Upper = coefs_df_full["(Intercept)", "CI_Upper"],
  SE = coefs_df_full["(Intercept)", "SE"],
  ParamLikelihood = coefs_df_full["(Intercept)", "ParamLikelihood"],
  GSI = ref_location,
  Estimated_EnergyDensity = intercept
)

# Step 5: Combine
GSI_estimates <- rbind(ref_row, GSI_effects)
rownames(GSI_estimates) <- NULL
GSI_estimates <- GSI_estimates[, c("GSI", setdiff(names(GSI_estimates), "GSI"))]

# Step 6: Compute average Work per location
library(dplyr)

# Check unique values
unique(DataSet$Group_Assignment)
avg_work <- DataSet %>%
  dplyr::group_by(Group_Assignment) %>%
  dplyr::summarise(Avg_Work = mean(Work_km2, na.rm = TRUE), .groups = "drop")

# Step 7: Merge with estimates
GSI_estimates <- merge(GSI_estimates, avg_work, by.x = "GSI", by.y = "Group_Assignment")

# Step 8: Linear regression of estimated body size ~ work
energydensity_work_model <- lm(Estimated_EnergyDensity ~ Avg_Work, data = GSI_estimates)
summary(energydensity_work_model)

# Step 9: Visualization
library(ggplot2)
ggplot(GSI_estimates, aes(x = Avg_Work, y = Estimated_EnergyDensity, label = GSI)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  geom_text(nudge_y = 0.05, size = 3) +
  labs(title = "Model-Averaged Estimated Energy Density vs. Migration Work",
       x = "Migration Work (km²)", y = "Estimated Energy Density (mJ/kg)") +
  theme_minimal() + 
   theme(
  plot.title = element_text(size = 16, face = "bold"),
  axis.title.x = element_text(size = 16, face = "bold"),
  axis.title.y = element_text(size = 16, face = "bold"),
  axis.text.x = element_text(size = 16),
  axis.text.y = element_text(size = 16),
  legend.title = element_text(size = 16, face = "bold"),
  legend.text = element_text(size = 16)
)


#Remove Chitina
GSI_estimates_noChitina <- GSI_estimates %>%
  filter(!GSI %in% c("Chitina"))

# Linear regression of estimated body size ~ work, no chitina
energydensity_work_model_noChitina <- lm(Estimated_EnergyDensity ~ Avg_Work, data = GSI_estimates_noChitina)
summary(energydensity_work_model_noChitina)

# Step 9: Visualization
library(ggplot2)
ggplot(GSI_estimates_noChitina, aes(x = Avg_Work, y = Estimated_EnergyDensity, label = GSI)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  geom_text(nudge_y = 0.05, size = 3) +
  labs(title = "Model-Averaged Estimated Energy Density vs. Migration Work",
       x = "Migration Work (km²)", y = "Estimated Energy Density (mJ/kg)") +
  theme_minimal() + 
   theme(
  plot.title = element_text(size = 16, face = "bold"),
  axis.title.x = element_text(size = 16, face = "bold"),
  axis.title.y = element_text(size = 16, face = "bold"),
  axis.text.x = element_text(size = 16),
  axis.text.y = element_text(size = 16),
  legend.title = element_text(size = 16, face = "bold"),
  legend.text = element_text(size = 16)
)


```


### Estimates Figure
```{r}
# Figure that displays parameter estimates + CI for each parameter in teh model set
paramestimates_energyGSI <- "energydensity_GSI/EnergyPDry_1_GSI_ModelAvg_Coefs_withLikelihoods.csv"

estimates_energyGSI<-read.csv(paramestimates_energyGSI)
str(estimates_energyGSI)

levels(factor(estimates_energyGSI$X))
estimates_energyGSI$X <- factor(estimates_energyGSI$X, 
                           levels = rev(c("(Intercept)",
                                          "Collection_RiverMile_m",
                                          "SexM",
                                          "Year2021",
                                          "Group_AssignmentChitina", 
                                          "Group_AssignmentGulkana",
                                          "Group_AssignmentGulkanaHatchery",
                                          "Group_AssignmentKlutinaLake",
                                          "Group_AssignmentKlutinaTonsinaOutlet",
                                          "Group_AssignmentLowerGroups",
                                          "Group_AssignmentSlana",
                                          "Group_AssignmentTanadaCopperLakes",
                                          "Group_AssignmentTazlina",
                                          "Group_AssignmentChitina:SexM",
                                          "Group_AssignmentGulkana:SexM",
                                          "Group_AssignmentGulkanaHatchery:SexM",
                                          "Group_AssignmentKlutinaLake:SexM",
                                          "Group_AssignmentKlutinaTonsinaOutlet:SexM",
                                          "Group_AssignmentLowerGroups:SexM",
                                          "Group_AssignmentSlana:SexM",
                                          "Group_AssignmentTanadaCopperLakes:SexM",
                                          "Group_AssignmentTazlina:SexM",
                                          "SexM:Year2021")))



ggplot(estimates_energyGSI, aes(x = Avg_Coef, y = X)) + 
  geom_point(size = 3) +  # For the coefficient estimate as dots
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.2) + # Horizontal CI bars
  labs(x = "Parameter Estimate", y = "Parameter") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  theme(axis.title = element_text(size = 24), 
        axis.text = element_text(size = 24))



```


```{r}
#visualizing model 6
ggplot(DataSet, aes(x = Group_Assignment, y = EnergyPDry_1, fill = Group_Assignment)) +
  geom_boxplot(position = position_dodge()) +
  labs(
    title = "EnergyPDry_1 by Group Assignment (GSI Working Group)",
    x = "Group Assignment",
    y = "EnergyPDry_1",
  ) +
  theme_minimal()

```